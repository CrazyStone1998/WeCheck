<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>test</title>
    <script>
        window.BMap_loadScriptTime = (new Date).getTime();
    </script>
    <!--百度地图api  暂时弃用-->
    <!--<script type="text/javascript" src="http://api.map.baidu.com/getscript?v=3.0&ak=nA50vfiO6QOheIIE03GNtlnrbnKEmG2T&quot;&services=&t=20180823175819"></script>-->
    <script type="text/javascript"
            src="https://webapi.amap.com/maps?v=1.4.8&key=9aab6b6fff994d6e7d3f187cf5422fd6"></script>

</head>
<body>
<script>
    function getCurrentPosition() {
        return new Promise((resolve, reject) => {

            AMap.plugin('AMap.Geolocation', function () {
                var geolocation = new AMap.Geolocation({
                    // 是否使用高精度定位，默认：true
                    enableHighAccuracy: true,
                    GeoLocationFirst: true
                })

                geolocation.getCurrentPosition()
                let firstInvokingTime = new Date(),//首次调用时间
                    maxWaitingSeconds = 5//最长等待时间

                // 低精度的也会保存  但会重复多次以获得更好的结果
                let result = null

                AMap.event.addListener(geolocation, 'complete', onComplete)
                AMap.event.addListener(geolocation, 'error', onError)

                function onComplete(data) {

                    if (!result || data.accuracy < result.accuracy) result = data

                    if (Date.now() - firstInvokingTime < maxWaitingSeconds) {
                        geolocation.getCurrentPosition()
                    } else {
                        resolve({lng: result.position.lng, lat: result.position.lat})
                    }
                }

                function onError(data) {

                    // 定位出错
                    console.log(`定位失败  ${Date.now()} ${data}`)

                    reject(data)

                }
            })
        })
    }

    // getCurrentPosition().then(p=>{
    //     alert(JSON.stringify(p))
    //     console.log(p)
    // },e=>{
    //     alert(e.message)
    //     console.log(e)
    // })


    var id, target, options;

    function success(pos) {
        var crd = pos.coords;

        alert(1)
    }

    function error(err) {
        alert('ERROR(' + err.code + '): ' + err.message);
    }

    target = {
        latitude: 0,
        longitude: 0
    };

    options = {
        enableHighAccuracy: false,
        timeout: 50000,
        maximumAge: 0
    };

    id = navigator.geolocation.watchPosition(success, error, options);
</script>
</body>
</html>